<!DOCTYPE html>
<html>
<head>
<title>Places</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <script>
  var lattitude = 0;
  var longitude = 0;
  var distance = 10;
  var placesData = "";
  var prevURL = [];
  var pageNo = 0;
  var map;

  //code to fetch lattitude and longitude
  $(document).ready(function(){
    $.get("http://ip-api.com/json", function(data, status){
        var obj = data;
				lattitude = obj.lat;
				longitude = obj.lon;
				if(lattitude!=0 && longitude!=0){
					var input = document.createElement("input");
					input.setAttribute("type", "hidden");
					input.setAttribute("name", "lattitude");
					input.setAttribute("value", lattitude);
					input.setAttribute("id","lattitude");
					//append to form element that you want .
					document.getElementById("travel-form").appendChild(input);
					
					input = document.createElement("input");
					input.setAttribute("type", "hidden");
					input.setAttribute("name", "longitude");
					input.setAttribute("value", longitude);
					input.setAttribute("id","longitude");
					//append to form element that you want .
					document.getElementById("travel-form").appendChild(input);

					document.getElementById("btn_search").removeAttribute('disabled');
				}

    });
}); 
  
  //code when radio button selection is changed
  $(function(){
    $("#rbt_clocation, #rbt_olocation").change(function(){
        if($("#rbt_clocation").is(":checked")){
            $("#txt_location").attr("disabled",true);
        }
        else if($("#rbt_olocation").is(":checked")){
            $("#txt_location").removeAttr("disabled");
            $("#txt_location").focus();   
        }
    });
});

$.validator.setDefaults( {
			submitHandler: function () {
			//set distance to 10
			if($('input[name="distance"]').val() == ""){
				$('input[name="distance"]').val('10');
			}
				$.ajax({
        url: 'http://localhost/',
        type: 'get',
        dataType: 'json',
        data: $('#travel-form').serialize(),
		beforeSend: function() {
        showProgressBar();
		},
        success: function(data) {
                   placesData = data;
				   //alert(placesData);
				   prevURL[0] = this.url;
				   showResults();
				},
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			alert("Excpetion " + errorThrown + XMLHttpRequest);
			//add error message red colored message
		}
			});
			}
		} );
  
  //code of validation
  $( document ).ready( function () {
			$( "#travel-form" ).validate( {
				rules: {
					keyword: {
						required: {
							depends:function(){
								$(this).val($.trim($(this).val()));
								return true;
							}
						}
					},
					location: {
						required: {
							depends:function(){
								$(this).val($.trim($(this).val()));
								return true;
							}
						}
					}
				},
				messages: {
					keyword: "Please enter a keyword",
					location: "Please enter a location"
				},
				errorElement: "em",
				errorPlacement: function ( error, element ) {
					// Add the `help-block` class to the error element
					error.addClass( "help-block" );
					error.insertAfter( element );
				},
				highlight: function ( element, errorClass, validClass ) {
					if($(element).attr('id') == 'txt_location'){
						$( element ).parents( ".col-sm-12" ).addClass( "has-error" ).removeClass( "has-success" );
					}else{
						$( element ).parents( ".col-sm-6" ).addClass( "has-error" ).removeClass( "has-success" );
					}
				},
				unhighlight: function (element, errorClass, validClass) {
					if($(element).attr('id') == 'txt_location'){
						$( element ).parents( ".col-sm-12" ).addClass( "has-success" ).removeClass( "has-error" );
					}else{
						$( element ).parents( ".col-sm-6" ).addClass( "has-success" ).removeClass( "has-error" );
					}
				}
				} )
			} );
			
function showProgressBar(){
	var html = "<div class=\"progress\">";
    html += "<div class=\"progress-bar progress-bar-striped active\" role=\"progressbar\" aria-valuenow=\"50\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width:50%; height:16px;\">";
    html += "</div></div>";
    document.getElementById('results').innerHTML = html;
}

function setTableRows(){
	$('#tb_results').on('click', '.clickable-row', function(event) {
  $(this).addClass('row-selected').siblings().removeClass('row-selected');
  $('#btn_details').removeAttr("disabled");
});
$('.table > tbody > tr > td > button').click(function() {
	if($(this).find('i').hasClass('glyphicon glyphicon-star-empty')){
		//add result to favorite list
		$(this).find('i').removeClass('glyphicon glyphicon-star-empty');
		$(this).find('i').addClass('glyphicon glyphicon-star');
	}else if($(this).find('i').hasClass('glyphicon glyphicon-star')){
		//remove result from favorite list
		$(this).find('i').removeClass('glyphicon glyphicon-star');
		$(this).find('i').addClass('glyphicon glyphicon-star-empty');
	}else{
		alert('list button clicked');
	}
});

}

function goToNextPage(token){
	//code to go to next page
	$.ajax({
        url: 'http://localhost/?pagetoken='+token+"&key=AIzaSyBcrBxlXi_PvW591GLcKs4St2gkJK_V4I0&libraries=places",
        type: 'get',
        dataType: 'json',
		beforeSend: function() {
			showProgressBar();
		},
        success: function(data) {
				pageNo += 1;
                placesData = data;
				prevURL[pageNo] = this.url;
				showResults();
		},
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			alert("Excpetion " + errorThrown + XMLHttpRequest);
		}
	});
}

function goToPrevPage(){
	$.ajax({
        url: prevURL[pageNo-1],
        type: 'get',
        dataType: 'json',
		beforeSend: function() {
			showProgressBar();
		},
        success: function(data) {
				pageNo -= 1;
                placesData = data;
				showResults();
		},
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			alert("Excpetion " + errorThrown + XMLHttpRequest);
		}
	});
}
			
function showResults(){
	if(placesData != ""){
		//var json = JSON.parse(placesData);
		var json = placesData;
		if(json.results.length==0){
			var html = "<div class=\"alert alert-warning text-left\" role=\"alert\"><strong>No records.</strong></div>";
			document.getElementById('results').innerHTML = html;
		}else{
			var html = " <div class=\"text-right\"><button class=\"btn btn-default right-align\" id=\"btn_details\" disabled>Details <span class=\"glyphicon glyphicon-chevron-right\"></span></button></div>";
			html += "<div class=\"table-responsive\"><table class=\"table table-hover\" id=\"tb_results\"><thead><tr><th>#</th><th>Category</th><th>Name</th><th>Address</th><th>Favorite</th><th>Details</th></tr></thead>";
			html += "<tbody>";
			for(i=0;i<json.results.length;i++){
				var result = json.results[i];
				html += "<tr class=\"clickable-row\">";
				html += "<td>"+(i+1)+"</td>";
				html += "<td><img src=\""+result.icon+"\" style=\"widhth:35px; height:35px;\"/></td>";
				html += "<td>"+result.name+"</td>";
				html += "<td>9"+result.vicinity+"</td>";
				html += "<td><button type=\"button\" class=\"btn btn-default\" id=\"btn_favorite\"><i class=\"glyphicon glyphicon-star-empty\"></i></button></td>";
				html += "<td><button type=\"button\" class=\"btn btn-default\"><i class=\"glyphicon glyphicon-chevron-right\"></i></button></td>";
				html += "</tr>";
				//html += "<tr><td><img src=\""+result.icon+"\" style=\"width:35px; height:35px;\"/></td><td><button class=\"placename\"onClick=\"getReviewsData(\'"+result.place_id+"\')\">"+result.name+"</button></td><td><button class=\"placeadd\"onClick=\"buildMap("+result.geometry.location.lat+","+result.geometry.location.lng+",this)\">"+result.vicinity+"</button></td></tr>";
			}
			html += "</tbody></table>";
			//check for next page token
			if(pageNo == 0){
				if(json.hasOwnProperty("next_page_token")){
					html += "<div><button type=\"button\" class=\"btn btn-default btn-pagination\" id=\"btn_next\" onClick=\"goToNextPage(\'"+json.next_page_token+"\')\">Next</button></div>";
				}
			}else{
				if(!json.hasOwnProperty("next_page_token")){
					html += "<div><button type=\"button\" class=\"btn btn-default btn-pagination\" onClick=\"goToPrevPage()\">Previous</button></div>";
				}else{
					html += "<div><button type=\"button\" class=\"btn btn-default btn-pagination\" onClick=\"goToPrevPage()\">Previous</button><button type=\"button\" class=\"btn btn-default btn-pagination\" id=\"btn_next\" onClick=\"goToNextPage(\'"+json.next_page_token+"\')\">Next</button></div>";
				}
			}
			document.getElementById('results').innerHTML = html;
			setTableRows();
		}
	}
}

//set autocomplete for location text box
function setAutoComplete(){
var defaultBounds = new google.maps.LatLngBounds(
  new google.maps.LatLng(-33.8902, 151.1759),
  new google.maps.LatLng(-33.8474, 151.2631));

var input = document.getElementById('txt_location');
var options = {
  bounds: defaultBounds,
  types: ['establishment']
};

autocomplete = new google.maps.places.Autocomplete(input, options);
}

//submit form
$(document).ready(function () {
            
        });
  </script>
</head>
<body>
<div class="container" style="margin:16px auto;">
<div class="col-sm-10 col-centered">
  <div class="panel panel-default">
    <div class="panel-heading"><b><h4>Travel and Entertainment Search</h4></b>
		<form data-toggle="validator" role="form" class="form-horizontal form-groups-bordered col-centered" id="travel-form" method="get" action=""> 
			<div class="form-group"> 
				<label for="txt_keyword" class="col-sm-3 control-label text-left">Keyword<span style="color:red">*</span></label> 
				<div class="col-sm-6 text-left"> <input type="text" class="form-control form-control-sm" id="txt_keyword" placeholder="" name="keyword"> </div> 
			</div>
			<div class="form-group">
				<label for="sel_category" class="col-sm-3 control-label text-left">Category</label>
				<div class="col-sm-4 control-label">
					<select class="form-control" id="sel_category" name="category">
						<option>Default</option>
						<option>Airport</option>
						<option>Amusement Park</option>
						<option>Aquarium</option>
						<option>Art Gallery</option>
						<option>Bakery</option>
						<option>Bar</option>
						<option>Beauty Salon</option>
						<option>Bowling Alley</option>
						<option>Bus Station</option>
						<option>Cafe</option>
						<option>Campground</option>
						<option>Car Rental</option>
						<option>Casino</option>
						<option>Lodging</option>
						<option>Movie Theater</option>
						<option>Museum</option>
						<option>Night Club</option>
						<option>Park</option>
						<option>Parking</option>
						<option>Restaurant</option>
						<option>Shopping Mall</option>
						<option>Stadium</option>
						<option>Subway Station</option>
						<option>Taxi Stand</option>
						<option>Train Station</option>
						<option>Transit Station</option>
						<option>Travel Agency</option>
						<option>Zoo</option>
					</select>
					</div>
				</div>
				<div class="form-group"> 
					<label for="txt_distance" class="col-sm-3 control-label text-left">Distance (miles)</label> 
					<div class="col-sm-4"> <input type="text" class="form-control" id="txt_distance" placeholder="10" name="distance"> </div> 
				</div>
				<div class="form-group">
					<label for="txt_distance" class="col-sm-3 control-label text-left">From<span style="color:red">*</span></label> 
					<div class="col-sm-6" style="float:left; text-align:left;">
					 <div class="radio">
						<label><input type="radio" name="rbt_location" id="rbt_clocation" checked>Current location</label>
					</div>
					<div class="radio">
						<label><input type="radio" name="rbt_location" id="rbt_olocation">Other. Please specify:</label>
					</div>
					<div class="col-sm-12"><input type="text" class="form-control" id="txt_location" name="location" placeholder="Enter a location" disabled></div>
					</div>
				</div>
				<div class="form-group" style="text-align:left;">
				<div class="col-sm-9">
				<button type="submit" class="btn btn-info" disabled id="btn_search" name="search"><span class="glyphicon glyphicon-search"></span> Search</button>
				<button type="button" class="btn btn-default">Clear</button>
				</div></div>
    </button>
	</form>	
	</div>
  </div>
 </div>
 <div class="col-sm-10 col-centered" style="margin:0 auto; text-align:center;">
 <div class="center-block">
 <ul class="nav nav-pills center-pills">
  <li class="active"><a data-toggle="pill" href="#results">Results</a></li>
  <li><a data-toggle="pill" href="#favorites">Favorites</a></li>
</ul><br/><br/>

<div class="tab-content">
  <div id="results" class="tab-pane fade in active">
  </div>
    <script>showResults();</script>
  </div>
  <div id="favorites" class="tab-pane fade">
    <h3>Favorites Here</h3>
    <p>Some content.</p>
  </div>
</div>
  </div>
  </div>
</div>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcrBxlXi_PvW591GLcKs4St2gkJK_V4I0&libraries=places&callback=setAutoComplete" async defer></script>
</body>
</html>
